<!-- Nightly Update Content -->
<div class="p-4">
  <!-- Current Status -->
  <div class="alert alert-info mb-4">
    <div class="flex items-center gap-2">
      <span class="text-lg">‚ÑπÔ∏è</span>
      <div class="flex-1">
        <div class="font-semibold">
          Status: {{ updateStatus.status | titlecase }}
        </div>
        <div class="text-sm" *ngIf="currentRequestId">
          Request ID: {{ currentRequestId }}
        </div>
        <div class="text-sm" *ngIf="activeUpdates.length > 0">
          Active updates: {{ activeUpdates.length }}
        </div>
      </div>
      <button
        class="btn btn-sm btn-outline"
        [class.loading]="isLoadingStatus"
        (click)="loadActiveUpdates()"
      >
        üîÑ Refresh
      </button>
    </div>
  </div>

  <!-- Progress Tracking -->
  <div
    class="alert alert-warning mb-4"
    *ngIf="progressInfo && updateStatus.isRunning"
  >
    <div class="flex items-center gap-2">
      <span class="text-lg">‚è≥</span>
      <div class="flex-1">
        <div class="font-semibold">{{ progressInfo.current_step }}</div>
        <div class="text-sm">
          Progress: {{ progressInfo.completed_symbols }}/{{
            progressInfo.total_symbols
          }}
          symbols ({{ progressInfo.progress_percentage }}%)
        </div>
        <div class="text-sm" *ngIf="progressInfo.current_symbol">
          Current: {{ progressInfo.current_symbol }}
        </div>
        <div
          class="text-sm"
          *ngIf="progressInfo.estimated_time_remaining_seconds"
        >
          Estimated time remaining:
          {{ progressInfo.estimated_time_remaining_seconds }}s
        </div>
      </div>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
      <div
        class="bg-blue-600 h-2 rounded-full transition-all duration-300"
        [style.width.%]="progressInfo.progress_percentage"
      ></div>
    </div>
  </div>

  <!-- Symbols Configuration -->
  <div class="form-control mb-4">
    <label class="label">
      <span class="label-text font-medium">Symbols</span>
    </label>
    <div class="form-control">
      <label class="label cursor-pointer justify-start gap-3">
        <input
          type="radio"
          name="symbolsOption"
          class="radio"
          [checked]="useDefaultSymbols"
          (change)="useDefaultSymbols = true; onSymbolsToggle()"
        />
        <span class="label-text"
          >Use default symbols (86 large & mid cap stocks)</span
        >
      </label>
    </div>
    <div class="form-control">
      <label class="label cursor-pointer justify-start gap-3">
        <input
          type="radio"
          name="symbolsOption"
          class="radio"
          [checked]="!useDefaultSymbols"
          (change)="useDefaultSymbols = false; onSymbolsToggle()"
        />
        <span class="label-text">Specify custom symbols</span>
      </label>
    </div>
    <div class="mt-2" *ngIf="!useDefaultSymbols">
      <input
        type="text"
        class="input input-bordered w-full"
        placeholder="Enter symbols separated by commas (e.g., AAPL, MSFT, GOOGL)"
        [(ngModel)]="symbolsInput"
        (input)="onSymbolsInputChange()"
      />
      <div class="text-sm text-gray-500 mt-1">
        Enter symbols separated by commas. They will be automatically converted
        to uppercase.
      </div>
    </div>
  </div>

  <!-- Update Options -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
    <div class="form-control">
      <label class="label cursor-pointer justify-start gap-3">
        <input
          type="checkbox"
          class="checkbox"
          [(ngModel)]="nightlyRequest.force_validation"
        />
        <span class="label-text">Force validation</span>
      </label>
      <div class="text-sm text-gray-500 ml-8">
        Validate existing data before updating
      </div>
    </div>

    <div class="form-control">
      <label class="label cursor-pointer justify-start gap-3">
        <input
          type="checkbox"
          class="checkbox"
          [(ngModel)]="nightlyRequest.enable_resampling"
        />
        <span class="label-text">Enable resampling</span>
      </label>
      <div class="text-sm text-gray-500 ml-8">
        Automatically resample to other timeframes
      </div>
    </div>
  </div>

  <!-- Concurrency Setting -->
  <div class="form-control mb-4">
    <label class="label">
      <span class="label-text font-medium">Max Concurrent Updates</span>
    </label>
    <input
      type="number"
      class="input input-bordered w-full"
      min="1"
      max="20"
      [(ngModel)]="nightlyRequest.max_concurrent"
      placeholder="5"
    />
    <div class="text-sm text-gray-500 mt-1">
      Maximum number of symbols to update simultaneously (1-20)
    </div>
  </div>

  <!-- Date Range Configuration -->
  <div class="form-control mb-6">
    <label class="label">
      <span class="label-text font-medium">Date Range</span>
    </label>
    <div class="form-control">
      <label class="label cursor-pointer justify-start gap-3">
        <input
          type="radio"
          name="dateRangeOption"
          class="radio"
          [checked]="!useCustomDateRange"
          (change)="useCustomDateRange = false; onDateRangeToggle()"
        />
        <span class="label-text"
          >Automatic (from last update to yesterday)</span
        >
      </label>
    </div>
    <div class="form-control">
      <label class="label cursor-pointer justify-start gap-3">
        <input
          type="radio"
          name="dateRangeOption"
          class="radio"
          [checked]="useCustomDateRange"
          (change)="useCustomDateRange = true; onDateRangeToggle()"
        />
        <span class="label-text">Custom date range</span>
      </label>
    </div>
    <div
      class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2"
      *ngIf="useCustomDateRange"
    >
      <div class="form-control">
        <label class="label">
          <span class="label-text">Start Date</span>
        </label>
        <input
          type="date"
          class="input input-bordered"
          [(ngModel)]="nightlyRequest.start_date"
        />
      </div>
      <div class="form-control">
        <label class="label">
          <span class="label-text">End Date</span>
        </label>
        <input
          type="date"
          class="input input-bordered"
          [(ngModel)]="nightlyRequest.end_date"
        />
      </div>
    </div>
    <div class="text-sm text-gray-500 mt-1" *ngIf="useCustomDateRange">
      Specify the exact date range to update. Leave end date empty to update
      until yesterday.
    </div>
    <div class="text-sm text-gray-500 mt-1" *ngIf="!useCustomDateRange">
      Automatically determines the date range based on the last update date for
      each symbol.
    </div>
  </div>

  <!-- Control Buttons -->
  <div class="flex gap-2 mb-6">
    <button
      class="btn btn-primary flex-1"
      [class.loading]="isLoading"
      [disabled]="isLoading || updateStatus.isRunning"
      (click)="startNightlyUpdate()"
    >
      <span *ngIf="!isLoading">üöÄ Start Nightly Update</span>
      <span *ngIf="isLoading">Starting...</span>
    </button>
  </div>
</div>

<!-- Help Text -->
<div class="text-sm text-base-content/70 mt-4">
  <p>
    <strong>Nightly Update</strong> automatically fetches 1-minute trading data
    for the specified symbols and date range, validates data completeness, and
    resamples to all target timeframes. The process runs in the background and
    provides real-time progress updates.
  </p>
  <p class="mt-2">
    <strong>Date Range Options:</strong>
  </p>
  <ul class="list-disc list-inside mt-1 ml-2">
    <li>
      <strong>Automatic:</strong> Determines the optimal date range based on
      existing data
    </li>
    <li>
      <strong>Custom:</strong> Specify exact start and end dates for the update
    </li>
  </ul>
</div>
